// Copyright Kuei-chun Chen, 2022-present. All rights reserved.

package hummingbird

import (
	"encoding/base64"
	"encoding/json"
	"log"
	"net/http"

	"github.com/simagix/gox"
	"go.mongodb.org/mongo-driver/bson"
)

const (
	mongopushPNG = `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`
	mongopushICO = `AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAACUWAAAlFgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACwsLAArKysNKSkpcykpKUQnJycA////ACcnJwApKSk/KSkpdioqKhAqKioAAAAAAAAAAAAAAAAAAAAAACoqKgApKSkEKioqNikpKaEpKSl4KysrNisrKzUrKys0KioqcSkpKaQqKio6KysrBQ0NDR0FBQV6BQUFNgAAAAAoKCgAKioqGygoKEomJiZFDw8Pvw8PD7kmJiY/KCgoOigoKDwpKSk/KCgoSisrKyIKCgpFAQEB8AEBAdYHBwc5AAAAAC4uLgEAAAAACAgIEgEBAdMBAQHNBQUFDgUFBQAAAAAALS0tAC4uLgEuLi4BEhISBwUFBXkBAQH4AQEB1AUFBTcAAAAACQkJAAgICBMBAQHUAQEBzgUFBQ4FBQUAAAAAAAAAAAAAAAAAAAAAAA4ODgATExMGBQUFewEBAfgBAQHTBQUFNwAAAAAHBwc1AQEB6AEBAcsGBgYOBgYGAAAAAAAAAAAAAAAAAAAAAAAAAAAADAwMABISEgcEBAR7AQEB+QICAsEICAg+AQEBxQEBAfsEBAR9GRkZAgwMDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKCgoADQ0NBwUFBXQGBgaRAgICxgEBAfsFBQWLDw4OCgsLCwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAQEAASEhITAwMDtQAAAP8CAgLSDAwMHwkJCQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAODg4ADw8PEQMDA8AAAAD/AAAA+wMDA5wICAgUBQUFAB0dHQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQEBAAAAAAAAMDAwsAwMDwgAAAP8AAAD+AgICpwcHBxcEBAQAAAAAAAAAAAAAAAAAAAAAADU1NQAAAAAABgYGHAICAksBAQFMAQEBSAQEBHMCAgLrAAAA/wAAAP8EBARzAAAAALGxsQAAAAAAAAAAAAAAAAA3NzcAAAAAAAgICGQBAQHjAQEB4wEBAeMBAQHhAQEB5gEBAekCAgLeBgYGdgQEBDwJCQkKBwcHAAAAAAAAAAAARkZGAAgICAAQEBAOBQUFJwMDAygDAwMoAwMDKAMDAygDAwMnCQkJNAICAscBAQH3BAQEZAAAAABVVVUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACwsLAAwMDBYDAwPJAQEB+QYGBmcAAAAAVVVVAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwcHAD///8ACgoKMQgICFIODg4ODAwMAAAAAAAAAAAA/HEAAPgAAAAYAAAAChwAAAYfAACCHwAAwB8AAOA/AADwfwAA8D8AAPgfAADAHwAAwAcAAMAHAAD/hwAA/8cAAA==`
)

// StartWebServer start an http server at port 3629
func StartWebServer(addr string) {
	http.HandleFunc("/favicon.ico", faviconHandler)
	http.HandleFunc("/", gox.Cors(handler))

	if err := http.ListenAndServe(addr, nil); err != nil {
		log.Fatalf("another mongopush is running: %v", err)
	}
}

func faviconHandler(w http.ResponseWriter, r *http.Request) {
	r.Close = true
	r.Header.Set("Connection", "close")
	w.Header().Set("Content-Type", "image/x-icon")
	ico, _ := base64.StdEncoding.DecodeString(mongopushICO)
	w.Write(ico)
}

func handler(w http.ResponseWriter, r *http.Request) {
	r.Close = true
	r.Header.Set("Connection", "close")
	if r.URL.Path == "/" {
		json.NewEncoder(w).Encode(bson.M{"ok": 1, "message": "hello neutrino!"})
	}
}
